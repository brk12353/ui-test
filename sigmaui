if not game:IsLoaded() then game.Loaded:Wait() end
task.wait(2)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local InsertService = game:GetService("InsertService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local filename = "AvatarChanger.json"

local currentAppliedUserId = nil
local lastApplicationTime = 0
local APPLICATION_COOLDOWN = 0.3
local isApplying = false
local lastRequestedUserId = nil

local SCREEN_PADDING = 10

local connections = {}
local activeTweens = {}
local pulseLoop = nil
local statusAnimations = {}
local toggleBtnPulseLoop = nil
local statusAnimationTask = nil

-- ============================================
-- STATUS MESSAGES CONFIGURATION
-- ============================================

local statusMessages = {
    ready = {text = "Ready", color = Color3.fromRGB(0, 255, 0), animate = false},
    fetching = {text = "Fetching Avatar...", color = Color3.fromRGB(150, 120, 255), animate = true},
    cleaning = {text = "Cleaning Character...", color = Color3.fromRGB(255, 140, 0), animate = true},
    applying = {text = "Applying Avatar...", color = Color3.fromRGB(80, 200, 255), animate = true},
    accessories = {text = "Loading Accessories...", color = Color3.fromRGB(120, 180, 255), animate = true},
    success = {text = "Avatar Applied!", color = Color3.fromRGB(80, 255, 150), animate = true},
    no_target = {text = "No Target Entered", color = Color3.fromRGB(255, 100, 100), animate = true},
    invalid = {text = "Invalid Target", color = Color3.fromRGB(255, 70, 70), animate = true},
    already = {text = "Already Applied!", color = Color3.fromRGB(255, 180, 50), animate = true},
    wait = {text = "Please Wait...", color = Color3.fromRGB(255, 180, 50), animate = true},
    auto_active = {text = "Auto Apply Active", color = Color3.fromRGB(80, 255, 150), animate = false},
    not_found = {text = "Target Not Found", color = Color3.fromRGB(255, 70, 70), animate = true},
    fetch_failed = {text = "Failed To Fetch", color = Color3.fromRGB(255, 70, 70), animate = true},
    no_humanoid = {text = "Humanoid Not Found", color = Color3.fromRGB(255, 70, 70), animate = true}
}

-- ============================================
-- FACE HANDLING SYSTEM
-- ============================================

local faceCache = {}
local lastFaceCheck = {}
local FACE_CHECK_COOLDOWN = 0.5

local function getCurrentFaceId(character)
    local head = character:FindFirstChild("Head")
    if not head then return nil end
    
    local face = head:FindFirstChild("face")
    if not face or not face:IsA("Decal") then return nil end
    
    local texture = face.Texture
    local faceId = texture:match("%d+")
    return faceId and tonumber(faceId) or nil
end

local function needsFaceUpdate(character, targetFaceId)
    if not targetFaceId or targetFaceId == "" then return false end
    
    local targetId = tonumber(targetFaceId)
    if not targetId or targetId <= 0 then return false end
    
    local now = tick()
    local characterId = tostring(character)
    
    if lastFaceCheck[characterId] and (now - lastFaceCheck[characterId]) < FACE_CHECK_COOLDOWN then
        return faceCache[characterId] ~= targetId
    end
    
    lastFaceCheck[characterId] = now
    local currentId = getCurrentFaceId(character)
    faceCache[characterId] = currentId
    
    return currentId ~= targetId
end

local function removeFaces(head)
    for _, child in ipairs(head:GetChildren()) do
        if child:IsA("Decal") and child.Name == "face" then
            pcall(function() child:Destroy() end)
        end
    end
end

local function applyFace(character, faceId, retries)
    retries = retries or 1
    
    if not faceId or faceId == "" then return false end
    
    local targetId = tonumber(faceId)
    if not targetId or targetId <= 0 then return false end
    
    local success = false
    
    for attempt = 1, retries do
        pcall(function()
            local head = character:FindFirstChild("Head")
            if not head then return end
            
            removeFaces(head)
            
            if attempt > 1 then
                task.wait(0.05)
            end
            
            local face = Instance.new("Decal")
            face.Name = "face"
            face.Face = Enum.NormalId.Front
            face.Texture = "rbxassetid://" .. targetId
            face.Parent = head
            
            faceCache[tostring(character)] = targetId
            success = true
        end)
        
        if success then break end
        
        if attempt < retries then
            task.wait(0.1)
        end
    end
    
    return success
end

-- ============================================
-- UTILITY FUNCTIONS
-- ============================================

local function bypassNamecall()
    local oldNamecall
    oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
        local method = getnamecallmethod()
        
        if method == "Kick" or method == "kick" then
            return
        end
        
        return oldNamecall(self, ...)
    end)
end

pcall(bypassNamecall)

local function trackConnection(conn)
    table.insert(connections, conn)
    return conn
end

local function cleanupConnections()
    for _, conn in ipairs(connections) do
        if conn and conn.Connected then 
            pcall(function() conn:Disconnect() end)
        end
    end
    connections = {}
end

local function cleanupTweens()
    for _, tw in ipairs(activeTweens) do
        if tw then
            pcall(function() tw:Cancel() end)
        end
    end
    activeTweens = {}
end

local function cleanupStatusAnimations()
    for _, anim in ipairs(statusAnimations) do
        if anim then 
            pcall(function() anim:Cancel() end)
        end
    end
    statusAnimations = {}
    
    if statusAnimationTask then
        pcall(function() task.cancel(statusAnimationTask) end)
        statusAnimationTask = nil
    end
end

local function cleanupPulseLoop()
    if pulseLoop then 
        pcall(function() pulseLoop:Disconnect() end)
        pulseLoop = nil
    end
end

local function cleanupToggleBtnPulse()
    if toggleBtnPulseLoop then
        pcall(function() task.cancel(toggleBtnPulseLoop) end)
        toggleBtnPulseLoop = nil
    end
end

local function cleanupAll()
    cleanupConnections()
    cleanupTweens()
    cleanupStatusAnimations()
    cleanupPulseLoop()
    cleanupToggleBtnPulse()
    
    faceCache = {}
    lastFaceCheck = {}
    
    pcall(function()
        if gui and gui.Parent then
            gui:Destroy()
        end
    end)
end

local function safeRead()
    local ok, data = pcall(function() return readfile and readfile(filename) end)
    if not ok or not data or data == "" then return nil end
    local suc, tbl = pcall(function() return HttpService:JSONDecode(data) end)
    return suc and tbl or nil
end

local function safeWrite(tbl)
    if not writefile then return end
    pcall(function() writefile(filename, HttpService:JSONEncode(tbl)) end)
end

local settings = safeRead() or { 
    target = "", 
    enabled = false, 
    uiSize = {x = 240, y = 140},
    uiPos = {x = 1, offsetX = -280, y = 0, offsetY = 20},
    minimized = false,
    showPreview = false,
    uiHidden = false,
    toggleBtnPos = {x = 0.5, offsetX = -35, y = 0, offsetY = 100}
}

if not settings.uiPos then
    settings.uiPos = {x = 1, offsetX = -280, y = 0, offsetY = 20}
end
if not settings.uiSize then
    settings.uiSize = {x = 240, y = 140}
end
if not settings.toggleBtnPos then
    settings.toggleBtnPos = {x = 0.5, offsetX = -35, y = 0, offsetY = 100}
end
if settings.uiHidden == nil then
    settings.uiHidden = false
end
if settings.showPreview == nil then
    settings.showPreview = false
end
if settings.minimized == nil then
    settings.minimized = false
end

if settings.uiSize.x == 250 then
    settings.uiSize.x = 280
    settings.uiPos.offsetX = -280
    safeWrite(settings)
end

local function trim(s) return (s:gsub("^%s*(.-)%s*$", "%1")) end
local function isDigits(s) return tonumber(s) ~= nil end

local descriptionCache = {}
local lastFetchTime = {}
local FETCH_COOLDOWN = 5
local MAX_CACHE_SIZE = 5

local function ResolveUserId(str)
    if not str or str == "" then return nil end
    str = trim(str)
    if isDigits(str) then return tonumber(str) end
    local ok, id = pcall(function() return Players:GetUserIdFromNameAsync(str) end)
    return ok and id or nil
end

local function tween(obj, props, time, style, dir)
    local info = TweenInfo.new(time or 0.25, style or Enum.EasingStyle.Quad, dir or Enum.EasingDirection.Out)
    local t = TweenService:Create(obj, info, props)
    table.insert(activeTweens, t)
    
    local conn
    conn = t.Completed:Connect(function()
        for i, tw in ipairs(activeTweens) do
            if tw == t then
                table.remove(activeTweens, i)
                break
            end
        end
        if conn then
            conn:Disconnect()
        end
    end)
    
    t:Play()
    return t
end

local function clampPositionToBounds(frame)
    local viewportSize = workspace.CurrentCamera.ViewportSize
    local frameSize = frame.AbsoluteSize
    
    local posX = frame.Position.X.Scale * viewportSize.X + frame.Position.X.Offset
    local posY = frame.Position.Y.Scale * viewportSize.Y + frame.Position.Y.Offset
    
    if posX < SCREEN_PADDING then
        posX = SCREEN_PADDING
    elseif posX + frameSize.X > viewportSize.X - SCREEN_PADDING then
        posX = viewportSize.X - frameSize.X - SCREEN_PADDING
    end
    
    if posY < SCREEN_PADDING then
        posY = SCREEN_PADDING
    elseif posY + frameSize.Y > viewportSize.Y - SCREEN_PADDING then
        posY = viewportSize.Y - frameSize.Y - SCREEN_PADDING
    end
    
    return UDim2.new(0, posX, 0, posY)
end

local function ensureUIInBounds(frame, animate)
    local clampedPos = clampPositionToBounds(frame)
    
    if clampedPos ~= frame.Position then
        if animate then
            tween(frame, {Position = clampedPos}, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        else
            frame.Position = clampedPos
        end
        
        settings.uiPos = {x = clampedPos.X.Scale, offsetX = clampedPos.X.Offset, y = clampedPos.Y.Scale, offsetY = clampedPos.Y.Offset}
        safeWrite(settings)
        return true
    end
    return false
end

-- ============================================
-- UI CREATION
-- ============================================

local gui = Instance.new("ScreenGui")
gui.Name = "AvatarChangerUI"
gui.Parent = PlayerGui
gui.IgnoreGuiInset = false
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
gui.DisplayOrder = 999999

local Frame = Instance.new("Frame")
Frame.Name = "MainFrame"
Frame.Size = UDim2.new(0, settings.uiSize.x or 240, 0, settings.uiSize.y or 140)
Frame.Position = UDim2.new(
    settings.uiPos and settings.uiPos.x or 1, 
    settings.uiPos and settings.uiPos.offsetX or -280, 
    settings.uiPos and settings.uiPos.y or 0, 
    settings.uiPos and settings.uiPos.offsetY or 20
)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
Frame.BackgroundTransparency = 0.1
Frame.BorderSizePixel = 0
Frame.AnchorPoint = Vector2.new(0,0)
Frame.Parent = gui

local UICorner = Instance.new("UICorner", Frame)
UICorner.CornerRadius = UDim.new(0, 10)

local Shadow = Instance.new("UIStroke", Frame)
Shadow.Thickness = 1.6
Shadow.Transparency = 0.35

local Glow = Instance.new("ImageLabel", Frame)
Glow.Name = "Glow"
Glow.Size = UDim2.new(1, 0, 1, 0)
Glow.Position = UDim2.new(0,0,0,0)
Glow.BackgroundTransparency = 1
Glow.Image = "rbxassetid://4999023345"
Glow.ImageTransparency = 0.6
Glow.ZIndex = 0

local PreviewPanel = Instance.new("Frame", gui)
PreviewPanel.Name = "PreviewPanel"
PreviewPanel.Size = UDim2.new(0, 180, 0, 280)
PreviewPanel.Position = UDim2.new(0, 0, 0, 0)
PreviewPanel.BackgroundColor3 = Color3.fromRGB(35, 37, 50)
PreviewPanel.BackgroundTransparency = 0.15
PreviewPanel.BorderSizePixel = 0
PreviewPanel.Visible = false
PreviewPanel.ZIndex = 2
Instance.new("UICorner", PreviewPanel).CornerRadius = UDim.new(0, 12)

local PreviewStroke = Instance.new("UIStroke", PreviewPanel)
PreviewStroke.Thickness = 2
PreviewStroke.Transparency = 0.3
PreviewStroke.Color = Color3.fromRGB(120, 140, 255)

local PreviewGlow = Instance.new("ImageLabel", PreviewPanel)
PreviewGlow.Name = "Glow"
PreviewGlow.Size = UDim2.new(1, 20, 1, 20)
PreviewGlow.Position = UDim2.new(0.5, 0, 0.5, 0)
PreviewGlow.AnchorPoint = Vector2.new(0.5, 0.5)
PreviewGlow.BackgroundTransparency = 1
PreviewGlow.Image = "rbxassetid://4999023345"
PreviewGlow.ImageTransparency = 0.7
PreviewGlow.ImageColor3 = Color3.fromRGB(120, 140, 255)
PreviewGlow.ZIndex = 1

local ToggleVisibilityBtn = Instance.new("ImageButton")
ToggleVisibilityBtn.Name = "ToggleVisibilityBtn"
ToggleVisibilityBtn.Size = UDim2.new(0, 55, 0, 55)
ToggleVisibilityBtn.Position = UDim2.new(
    settings.toggleBtnPos and settings.toggleBtnPos.x or 0.5, 
    settings.toggleBtnPos and settings.toggleBtnPos.offsetX or -35, 
    settings.toggleBtnPos and settings.toggleBtnPos.y or 0, 
    settings.toggleBtnPos and settings.toggleBtnPos.offsetY or 100
)
ToggleVisibilityBtn.AnchorPoint = Vector2.new(0.5, 0.5)
ToggleVisibilityBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
ToggleVisibilityBtn.BackgroundTransparency = 0.1
ToggleVisibilityBtn.BorderSizePixel = 0
ToggleVisibilityBtn.Image = ""
ToggleVisibilityBtn.ZIndex = 999999
ToggleVisibilityBtn.Parent = gui

Instance.new("UICorner", ToggleVisibilityBtn).CornerRadius = UDim.new(1, 0)

local ToggleBtnStroke = Instance.new("UIStroke", ToggleVisibilityBtn)
ToggleBtnStroke.Thickness = 2.5
ToggleBtnStroke.Transparency = 0.3
ToggleBtnStroke.Color = Color3.fromRGB(120, 140, 255)

local ToggleBtnGlow = Instance.new("ImageLabel", ToggleVisibilityBtn)
ToggleBtnGlow.Name = "Glow"
ToggleBtnGlow.Size = UDim2.new(1.4, 0, 1.4, 0)
ToggleBtnGlow.Position = UDim2.new(0.5, 0, 0.5, 0)
ToggleBtnGlow.AnchorPoint = Vector2.new(0.5, 0.5)
ToggleBtnGlow.BackgroundTransparency = 1
ToggleBtnGlow.Image = "rbxassetid://4999023345"
ToggleBtnGlow.ImageTransparency = 0.6
ToggleBtnGlow.ImageColor3 = Color3.fromRGB(120, 140, 255)
ToggleBtnGlow.ZIndex = 999998

local ToggleBtnIcon = Instance.new("TextLabel", ToggleVisibilityBtn)
ToggleBtnIcon.Name = "Icon"
ToggleBtnIcon.Size = UDim2.new(1, 0, 1, 0)
ToggleBtnIcon.BackgroundTransparency = 1
ToggleBtnIcon.Text = "üëÅ"
ToggleBtnIcon.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleBtnIcon.Font = Enum.Font.GothamBold
ToggleBtnIcon.TextSize = 22
ToggleBtnIcon.ZIndex = 1000000

local ToggleBtnPulse = Instance.new("Frame", ToggleVisibilityBtn)
ToggleBtnPulse.Name = "Pulse"
ToggleBtnPulse.Size = UDim2.new(1, 0, 1, 0)
ToggleBtnPulse.Position = UDim2.new(0.5, 0, 0.5, 0)
ToggleBtnPulse.AnchorPoint = Vector2.new(0.5, 0.5)
ToggleBtnPulse.BackgroundColor3 = Color3.fromRGB(120, 140, 255)
ToggleBtnPulse.BackgroundTransparency = 0.7
ToggleBtnPulse.BorderSizePixel = 0
ToggleBtnPulse.ZIndex = 999997
Instance.new("UICorner", ToggleBtnPulse).CornerRadius = UDim.new(1, 0)

local function startToggleBtnPulse()
    if toggleBtnPulseLoop then
        pcall(function() task.cancel(toggleBtnPulseLoop) end)
    end
    
    toggleBtnPulseLoop = task.spawn(function()
        while ToggleVisibilityBtn and ToggleVisibilityBtn.Parent do
            tween(ToggleBtnPulse, {Size = UDim2.new(1.3, 0, 1.3, 0), BackgroundTransparency = 1}, 1.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            task.wait(0.1)
            ToggleBtnPulse.Size = UDim2.new(1, 0, 1, 0)
            ToggleBtnPulse.BackgroundTransparency = 0.7
            task.wait(1.4)
        end
    end)
end

startToggleBtnPulse()

local toggleDragging, toggleDragStart, toggleStartPos, toggleDragConnection

local function updateToggleDrag(input)
    local delta = input.Position - toggleDragStart
    local newPos = UDim2.new(toggleStartPos.X.Scale, toggleStartPos.X.Offset + delta.X, toggleStartPos.Y.Scale, toggleStartPos.Y.Offset + delta.Y)
    
    local viewportSize = workspace.CurrentCamera.ViewportSize
    local btnSize = ToggleVisibilityBtn.AbsoluteSize
    
    local posX = newPos.X.Scale * viewportSize.X + newPos.X.Offset
    local posY = newPos.Y.Scale * viewportSize.Y + newPos.Y.Offset
    
    posX = math.clamp(posX, btnSize.X/2 + SCREEN_PADDING, viewportSize.X - btnSize.X/2 - SCREEN_PADDING)
    posY = math.clamp(posY, btnSize.Y/2 + SCREEN_PADDING, viewportSize.Y - btnSize.Y/2 - SCREEN_PADDING)
    
    ToggleVisibilityBtn.Position = UDim2.new(0, posX, 0, posY)
end

trackConnection(ToggleVisibilityBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        toggleDragging = true
        toggleDragStart = input.Position
        toggleStartPos = ToggleVisibilityBtn.Position
        
        tween(ToggleVisibilityBtn, {Size = UDim2.new(0, 60, 0, 60)}, 0.15, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        tween(ToggleBtnStroke, {Thickness = 3.5}, 0.15)
        
        if toggleDragConnection then 
            pcall(function() toggleDragConnection:Disconnect() end)
        end
        toggleDragConnection = trackConnection(input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                toggleDragging = false
                tween(ToggleVisibilityBtn, {Size = UDim2.new(0, 55, 0, 55)}, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
                tween(ToggleBtnStroke, {Thickness = 2.5}, 0.2)
                
                local pos = ToggleVisibilityBtn.Position
                settings.toggleBtnPos = {x = pos.X.Scale, offsetX = pos.X.Offset, y = pos.Y.Scale, offsetY = pos.Y.Offset}
                safeWrite(settings)
            end
        end))
    end
end))

trackConnection(UserInputService.InputChanged:Connect(function(input)
    if toggleDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        updateToggleDrag(input)
    end
end))

local TitleBar = Instance.new("Frame", Frame)
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.Position = UDim2.new(0,0,0,0)
TitleBar.BackgroundTransparency = 1

local TitleLabel = Instance.new("TextLabel", TitleBar)
TitleLabel.Size = UDim2.new(1, -60, 1, 0)
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "Avatar Changer"
TitleLabel.TextColor3 = Color3.fromRGB(255,255,255)
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 16
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

local Mini = Instance.new("TextButton", TitleBar)
Mini.Name = "Minimize"
Mini.Size = UDim2.new(0, 28, 0, 22)
Mini.Position = UDim2.new(1, -36, 0, 4)
Mini.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
Mini.BackgroundTransparency = 0.3
Mini.Text = "-"
Mini.TextColor3 = Color3.fromRGB(255,255,255)
Mini.Font = Enum.Font.GothamBold
Mini.TextSize = 18
Mini.ZIndex = 10
Instance.new("UICorner", Mini).CornerRadius = UDim.new(0, 6)

local ToggleBtn = Instance.new("TextButton", TitleBar)
ToggleBtn.Name = "ToggleBtn"
ToggleBtn.Size = UDim2.new(0, 44, 0, 22)
ToggleBtn.Position = UDim2.new(1, -86, 0, 4)
ToggleBtn.BackgroundTransparency = 0.15
ToggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 13
ToggleBtn.ZIndex = 10
Instance.new("UICorner", ToggleBtn)

local Input = Instance.new("TextBox", Frame)
Input.Name = "TargetInput"
Input.Size = UDim2.new(1, -20, 0, 30)
Input.Position = UDim2.new(0, 10, 0, 40)
Input.BackgroundColor3 = Color3.fromRGB(60,60,80)
Input.BackgroundTransparency = 0.12
Input.TextColor3 = Color3.fromRGB(255,255,255)
Input.PlaceholderText = "Target Username or ID"
Input.Text = settings.target or ""
Input.Font = Enum.Font.Gotham
Input.TextSize = 14
Instance.new("UICorner", Input)

local ApplyBtn = Instance.new("TextButton", Frame)
ApplyBtn.Name = "ApplyBtn"
ApplyBtn.Size = UDim2.new(0.5, -15, 0, 32)
ApplyBtn.Position = UDim2.new(0, 10, 0, 80)
ApplyBtn.Text = "Apply Once"
ApplyBtn.BackgroundColor3 = Color3.fromRGB(20,120,60)
ApplyBtn.TextColor3 = Color3.fromRGB(255,255,255)
ApplyBtn.Font = Enum.Font.GothamBold
ApplyBtn.TextSize = 14
Instance.new("UICorner", ApplyBtn)

local PersistToggle = Instance.new("TextButton", Frame)
PersistToggle.Name = "PersistToggle"
PersistToggle.Size = UDim2.new(0.5, -15, 0, 32)
PersistToggle.Position = UDim2.new(0.5, 5, 0, 80)
PersistToggle.TextColor3 = Color3.fromRGB(255,255,255)
PersistToggle.Font = Enum.Font.GothamBold
PersistToggle.TextSize = 14
Instance.new("UICorner", PersistToggle)

local StatusContainer = Instance.new("Frame", Frame)
StatusContainer.Name = "StatusContainer"
StatusContainer.Size = UDim2.new(1, -20, 0, 28)
StatusContainer.Position = UDim2.new(0, 10, 1, -27)
StatusContainer.BackgroundTransparency = 1
StatusContainer.BorderSizePixel = 0

local StatusDot = Instance.new("Frame", StatusContainer)
StatusDot.Name = "StatusDot"
StatusDot.Size = UDim2.new(0, 5, 0, 5)
StatusDot.Position = UDim2.new(0, 10, 0.5, -5)
StatusDot.BackgroundColor3 = Color3.fromRGB(120, 140, 255)
StatusDot.BorderSizePixel = 0
Instance.new("UICorner", StatusDot).CornerRadius = UDim.new(1, 0)

local DotGlow = Instance.new("ImageLabel", StatusDot)
DotGlow.Name = "Glow"
DotGlow.Size = UDim2.new(2, 0, 2, 0)
DotGlow.Position = UDim2.new(0.5, 0, 0.5, 0)
DotGlow.AnchorPoint = Vector2.new(0.5, 0.5)
DotGlow.BackgroundTransparency = 1
DotGlow.Image = "rbxassetid://4999023345"
DotGlow.ImageTransparency = 0.4
DotGlow.ImageColor3 = Color3.fromRGB(120, 140, 255)
DotGlow.ZIndex = 0

local Status = Instance.new("TextLabel", StatusContainer)
Status.Name = "Status"
Status.Size = UDim2.new(1, -32, 1, 0)
Status.Position = UDim2.new(0, 30, 0, -1)
Status.BackgroundTransparency = 1
Status.Text = "Ready"
Status.TextColor3 = Color3.fromRGB(220,220,230)
Status.Font = Enum.Font.GothamMedium
Status.TextSize = 13
Status.TextXAlignment = Enum.TextXAlignment.Left
Status.TextYAlignment = Enum.TextYAlignment.Center

local PreviewHeader = Instance.new("Frame", PreviewPanel)
PreviewHeader.Size = UDim2.new(1, 0, 0, 35)
PreviewHeader.Position = UDim2.new(0, 0, 0, 0)
PreviewHeader.BackgroundColor3 = Color3.fromRGB(45, 48, 65)
PreviewHeader.BackgroundTransparency = 0.2
PreviewHeader.BorderSizePixel = 0
PreviewHeader.ZIndex = 3
Instance.new("UICorner", PreviewHeader).CornerRadius = UDim.new(0, 12)

local PreviewIcon = Instance.new("TextLabel", PreviewHeader)
PreviewIcon.Size = UDim2.new(0, 20, 0, 20)
PreviewIcon.Position = UDim2.new(0, 8, 0.5, -10)
PreviewIcon.BackgroundTransparency = 1
PreviewIcon.Text = "üë§"
PreviewIcon.TextColor3 = Color3.fromRGB(150, 180, 255)
PreviewIcon.Font = Enum.Font.GothamBold
PreviewIcon.TextSize = 14
PreviewIcon.ZIndex = 4

local PreviewTitle = Instance.new("TextLabel", PreviewHeader)
PreviewTitle.Size = UDim2.new(1, -35, 1, 0)
PreviewTitle.Position = UDim2.new(0, 32, 0, 0)
PreviewTitle.BackgroundTransparency = 1
PreviewTitle.Text = "PREVIEW"
PreviewTitle.TextColor3 = Color3.fromRGB(220, 230, 255)
PreviewTitle.Font = Enum.Font.GothamBold
PreviewTitle.TextSize = 12
PreviewTitle.TextXAlignment = Enum.TextXAlignment.Left
PreviewTitle.ZIndex = 4

local PreviewDivider = Instance.new("Frame", PreviewPanel)
PreviewDivider.Size = UDim2.new(1, -20, 0, 1)
PreviewDivider.Position = UDim2.new(0, 10, 0, 38)
PreviewDivider.BackgroundColor3 = Color3.fromRGB(120, 140, 255)
PreviewDivider.BackgroundTransparency = 0.5
PreviewDivider.BorderSizePixel = 0
PreviewDivider.ZIndex = 3

local AvatarImageContainer = Instance.new("Frame", PreviewPanel)
AvatarImageContainer.Size = UDim2.new(1, -20, 0, 160)
AvatarImageContainer.Position = UDim2.new(0, 10, 0, 45)
AvatarImageContainer.BackgroundColor3 = Color3.fromRGB(25, 28, 38)
AvatarImageContainer.BackgroundTransparency = 0.3
AvatarImageContainer.BorderSizePixel = 0
AvatarImageContainer.ZIndex = 3
Instance.new("UICorner", AvatarImageContainer).CornerRadius = UDim.new(0, 10)

local AvatarImageStroke = Instance.new("UIStroke", AvatarImageContainer)
AvatarImageStroke.Thickness = 1.5
AvatarImageStroke.Transparency = 0.6
AvatarImageStroke.Color = Color3.fromRGB(80, 100, 150)

local AvatarImage = Instance.new("ImageLabel", AvatarImageContainer)
AvatarImage.Size = UDim2.new(1, -6, 1, -6)
AvatarImage.Position = UDim2.new(0, 3, 0, 3)
AvatarImage.BackgroundTransparency = 1
AvatarImage.Image = ""
AvatarImage.ZIndex = 4
Instance.new("UICorner", AvatarImage).CornerRadius = UDim.new(0, 8)

local LoadingLabel = Instance.new("TextLabel", AvatarImageContainer)
LoadingLabel.Size = UDim2.new(1, 0, 1, 0)
LoadingLabel.BackgroundTransparency = 1
LoadingLabel.Text = "No Preview"
LoadingLabel.TextColor3 = Color3.fromRGB(150, 160, 180)
LoadingLabel.Font = Enum.Font.GothamMedium
LoadingLabel.TextSize = 12
LoadingLabel.ZIndex = 5

local UserInfoContainer = Instance.new("Frame", PreviewPanel)
UserInfoContainer.Size = UDim2.new(1, -20, 0, 60)
UserInfoContainer.Position = UDim2.new(0, 10, 0, 213)
UserInfoContainer.BackgroundTransparency = 1
UserInfoContainer.ZIndex = 3

local UsernameLabel = Instance.new("TextLabel", UserInfoContainer)
UsernameLabel.Size = UDim2.new(1, 0, 0, 18)
UsernameLabel.Position = UDim2.new(0, 0, 0, 0)
UsernameLabel.BackgroundTransparency = 1
UsernameLabel.Text = "Username: ---"
UsernameLabel.TextColor3 = Color3.fromRGB(240, 245, 255)
UsernameLabel.Font = Enum.Font.GothamBold
UsernameLabel.TextSize = 11
UsernameLabel.TextXAlignment = Enum.TextXAlignment.Left
UsernameLabel.TextTruncate = Enum.TextTruncate.AtEnd
UsernameLabel.ZIndex = 4
UsernameLabel.RichText = true

local UserIdLabel = Instance.new("TextLabel", UserInfoContainer)
UserIdLabel.Size = UDim2.new(1, 0, 0, 16)
UserIdLabel.Position = UDim2.new(0, 0, 0, 20)
UserIdLabel.BackgroundTransparency = 1
UserIdLabel.Text = "User ID: ---"
UserIdLabel.TextColor3 = Color3.fromRGB(180, 190, 210)
UserIdLabel.Font = Enum.Font.Gotham
UserIdLabel.TextSize = 10
UserIdLabel.TextXAlignment = Enum.TextXAlignment.Left
UserIdLabel.ZIndex = 4
UserIdLabel.RichText = true

local StatusLabel = Instance.new("TextLabel", UserInfoContainer)
StatusLabel.Size = UDim2.new(1, 0, 0, 16)
StatusLabel.Position = UDim2.new(0, 0, 0, 40)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "‚úì Ready to Apply"
StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 150)
StatusLabel.Font = Enum.Font.GothamMedium
StatusLabel.TextSize = 10
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.ZIndex = 4

local PreviewToggle = Instance.new("TextButton", TitleBar)
PreviewToggle.Name = "PreviewToggle"
PreviewToggle.Size = UDim2.new(0, 22, 0, 22)
PreviewToggle.Position = UDim2.new(1, -114, 0, 4)
PreviewToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
PreviewToggle.BackgroundTransparency = 0.25
PreviewToggle.Text = "üëÅ"
PreviewToggle.TextColor3 = Color3.fromRGB(255,255,255)
PreviewToggle.Font = Enum.Font.GothamBold
PreviewToggle.TextSize = 12
PreviewToggle.ZIndex = 10
Instance.new("UICorner", PreviewToggle).CornerRadius = UDim.new(0, 6)

-- ============================================
-- STATUS FUNCTIONS
-- ============================================

local function setStatus(statusKey, customText)
    local statusData = statusMessages[statusKey]
    if not statusData then
        warn("Invalid status key: " .. tostring(statusKey))
        return
    end
    
    local text = customText or statusData.text
    local color = statusData.color
    local animate = statusData.animate
    
    Status.Text = text
    StatusDot.BackgroundColor3 = color
    DotGlow.ImageColor3 = color
    
    cleanupStatusAnimations()
    cleanupPulseLoop()
    
    if animate then
        local pulseIn = tween(StatusDot, {Size = UDim2.new(0, 12, 0, 12), Position = UDim2.new(0, 8, 0.5, -7)}, 0.25, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        table.insert(statusAnimations, pulseIn)
        
        if statusAnimationTask then
            pcall(function() task.cancel(statusAnimationTask) end)
        end
        
        statusAnimationTask = task.spawn(function()
            task.wait(0.25)
            local pulseOut = tween(StatusDot, {Size = UDim2.new(0, 10, 0, 10), Position = UDim2.new(0, 10, 0.5, -5)}, 0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut)
            table.insert(statusAnimations, pulseOut)
            task.wait(0.2)
            
            local elapsed = 0
            pulseLoop = trackConnection(RunService.RenderStepped:Connect(function(dt)
                elapsed = elapsed + dt
                local scale = 1 + math.sin(elapsed * 3) * 0.15
                StatusDot.Size = UDim2.new(0, 10 * scale, 0, 10 * scale)
                StatusDot.Position = UDim2.new(0, 10 + (5 - 5 * scale), 0.5, -5 * scale)
                DotGlow.ImageTransparency = 0.3 + math.sin(elapsed * 3) * 0.2
            end))
        end)
    else
        StatusDot.Size = UDim2.new(0, 10, 0, 10)
        StatusDot.Position = UDim2.new(0, 10, 0.5, -5)
        DotGlow.ImageTransparency = 0.4
    end
end

-- ============================================
-- PREVIEW FUNCTIONS
-- ============================================

local currentPreviewThread = nil

local function updatePreviewPosition()
    local framePos = Frame.Position
    local frameSize = Frame.AbsoluteSize
    local previewSize = PreviewPanel.AbsoluteSize
    local viewportSize = workspace.CurrentCamera.ViewportSize
    
    local framePosX = framePos.X.Scale * viewportSize.X + framePos.X.Offset
    local framePosY = framePos.Y.Scale * viewportSize.Y + framePos.Y.Offset
    
    local rightSpace = viewportSize.X - (framePosX + frameSize.X)
    local leftSpace = framePosX
    
    local newPosX, newPosY
    
    if rightSpace >= previewSize.X + 15 + SCREEN_PADDING then
        newPosX = framePosX + frameSize.X + 15
    elseif leftSpace >= previewSize.X + 15 + SCREEN_PADDING then
        newPosX = framePosX - previewSize.X - 15
    else
        newPosX = framePosX + frameSize.X + 15
    end
    
    newPosY = framePosY
    
    if newPosX < SCREEN_PADDING then
        newPosX = SCREEN_PADDING
    elseif newPosX + previewSize.X > viewportSize.X - SCREEN_PADDING then
        newPosX = viewportSize.X - previewSize.X - SCREEN_PADDING
    end
    
    if newPosY < SCREEN_PADDING then
        newPosY = SCREEN_PADDING
    elseif newPosY + previewSize.Y > viewportSize.Y - SCREEN_PADDING then
        newPosY = viewportSize.Y - previewSize.Y - SCREEN_PADDING
    end
    
    local targetPos = UDim2.new(0, newPosX, 0, newPosY)
    tween(PreviewPanel, {Position = targetPos}, 0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
end

local function loadPreview(targetText)
    if currentPreviewThread then
        pcall(function() task.cancel(currentPreviewThread) end)
        currentPreviewThread = nil
    end
    
    if not PreviewPanel.Visible then
        return
    end
    
    LoadingLabel.Text = "Loading..."
    AvatarImage.Image = ""
    UsernameLabel.Text = "Username: ---"
    UserIdLabel.Text = "User ID: ---"
    StatusLabel.Text = "Loading..."
    StatusLabel.TextColor3 = Color3.fromRGB(255, 180, 80)
    
    if not targetText or targetText == "" then
        LoadingLabel.Text = "No Preview"
        StatusLabel.Text = "‚ö† Enter Target"
        return
    end
    
    currentPreviewThread = task.spawn(function()
        if not PreviewPanel.Visible then return end
        
        local userId = nil
        local userIdSuccess = pcall(function()
            userId = ResolveUserId(targetText)
        end)
        
        if not PreviewPanel.Visible then return end
        
        if not userIdSuccess or not userId then
            LoadingLabel.Text = "User Not Found"
            UsernameLabel.Text = "Username: Invalid"
            StatusLabel.Text = "‚úó Not Found"
            StatusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            return
        end
        
        local username = "User_" .. tostring(userId)
        pcall(function()
            username = Players:GetNameFromUserIdAsync(userId)
        end)
        
        if not PreviewPanel.Visible then return end
        
        UsernameLabel.Text = '<font color="rgb(140,160,200)">User:</font> <font color="rgb(255,255,255)">' .. username .. '</font>'
        UserIdLabel.Text = '<font color="rgb(140,160,200)">ID:</font> <font color="rgb(200,210,230)">' .. tostring(userId) .. '</font>'
        
        if not PreviewPanel.Visible then return end
        
        local thumbnailUrl = "rbxthumb://type=Avatar&id=" .. userId .. "&w=420&h=420"
        
        AvatarImage.Image = thumbnailUrl
        LoadingLabel.Text = ""
        StatusLabel.Text = "‚úì Ready"
        StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 150)
        
        task.wait(0.3)
        
        if not PreviewPanel.Visible then return end
        
        if not AvatarImage.Image or AvatarImage.Image == "" then
            local apiSuccess, apiResult = pcall(function()
                return Players:GetUserThumbnailAsync(userId, Enum.ThumbnailType.AvatarFull, Enum.ThumbnailSize.Size420x420)
            end)
            
            if apiSuccess and apiResult and apiResult ~= "" then
                AvatarImage.Image = apiResult
                LoadingLabel.Text = ""
                StatusLabel.Text = "‚úì Ready"
                StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 150)
            else
                LoadingLabel.Text = "No Image"
                StatusLabel.Text = "‚ö† Image Failed"
                StatusLabel.TextColor3 = Color3.fromRGB(255, 180, 80)
            end
        end
        
        currentPreviewThread = nil
    end)
end

-- ============================================
-- UI VISIBILITY FUNCTIONS
-- ============================================

local isTogglingVisibility = false

local function toggleUIVisibility()
    if isTogglingVisibility then
        return
    end
    
    isTogglingVisibility = true
    settings.uiHidden = not settings.uiHidden
    safeWrite(settings)
    
    if settings.uiHidden then
        ToggleBtnIcon.Text = "üëÅ‚Äçüó®"
        tween(Frame, {BackgroundTransparency = 1}, 0.3)
        for _, child in ipairs(Frame:GetDescendants()) do
            if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
                tween(child, {TextTransparency = 1}, 0.3)
                if child:IsA("TextButton") or child:IsA("TextBox") then
                    tween(child, {BackgroundTransparency = 1}, 0.3)
                end
            elseif child:IsA("ImageLabel") then
                tween(child, {ImageTransparency = 1}, 0.3)
            elseif child:IsA("Frame") and child.Name ~= "Glow" then
                tween(child, {BackgroundTransparency = 1}, 0.3)
            elseif child:IsA("UIStroke") then
                tween(child, {Transparency = 1}, 0.3)
            end
        end
        local wasPreviewVisible = PreviewPanel.Visible
        if wasPreviewVisible then
            tween(PreviewPanel, {BackgroundTransparency = 1}, 0.3)
            for _, child in ipairs(PreviewPanel:GetDescendants()) do
                if child:IsA("TextLabel") then
                    tween(child, {TextTransparency = 1}, 0.3)
                elseif child:IsA("ImageLabel") then
                    tween(child, {ImageTransparency = 1}, 0.3)
                elseif child:IsA("Frame") and child.Name ~= "Glow" then
                    tween(child, {BackgroundTransparency = 1}, 0.3)
                elseif child:IsA("UIStroke") then
                    tween(child, {Transparency = 1}, 0.3)
                end
            end
        end
        
        tween(ToggleVisibilityBtn, {BackgroundColor3 = Color3.fromRGB(255, 80, 100)}, 0.3)
        tween(ToggleBtnStroke, {Color = Color3.fromRGB(255, 100, 120)}, 0.3)
        ToggleBtnGlow.ImageColor3 = Color3.fromRGB(255, 100, 120)
        
        task.wait(0.35)
        Frame.Visible = false
        if wasPreviewVisible then
            PreviewPanel.Visible = false
        end
        
    else
        ToggleBtnIcon.Text = "üëÅ"
        local targetPos = UDim2.new(settings.uiPos.x, settings.uiPos.offsetX, settings.uiPos.y, settings.uiPos.offsetY)
        Frame.Position = targetPos
        Frame.Visible = true
        Frame.BackgroundTransparency = 1
        for _, child in ipairs(Frame:GetDescendants()) do
            if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
                child.TextTransparency = 1
                if child:IsA("TextButton") or child:IsA("TextBox") then
                    child.BackgroundTransparency = 1
                end
            elseif child:IsA("ImageLabel") then
                child.ImageTransparency = 1
            elseif child:IsA("Frame") and child.Name ~= "Glow" then
                child.BackgroundTransparency = 1
            elseif child:IsA("UIStroke") then
                child.Transparency = 1
            end
        end
        tween(Frame, {BackgroundTransparency = 0.1}, 0.4)
        task.wait(0.1)
        for _, child in ipairs(Frame:GetDescendants()) do
            if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
                tween(child, {TextTransparency = 0}, 0.3)
                if child:IsA("TextButton") then
                    local originalTransparency = 0.15
                    if child.Name == "Minimize" or child.Name == "PreviewToggle" then
                        originalTransparency = 0.3
                    elseif child.Name == "ToggleBtn" then
                        originalTransparency = 0.15
                    end
                    tween(child, {BackgroundTransparency = originalTransparency}, 0.3)
                elseif child:IsA("TextBox") then
                    tween(child, {BackgroundTransparency = 0.12}, 0.3)
                end
            elseif child:IsA("ImageLabel") and child.Name == "Glow" then
                tween(child, {ImageTransparency = 0.6}, 0.3)
            elseif child:IsA("Frame") and child.Name == "StatusDot" then
                tween(child, {BackgroundTransparency = 0}, 0.3)
            elseif child:IsA("UIStroke") then
                local originalTransparency = 0.35
                if child.Parent == Frame then
                    originalTransparency = 0.35
                end
                tween(child, {Transparency = originalTransparency}, 0.3)
            end
        end
        if settings.showPreview then
            PreviewPanel.Visible = true
            PreviewPanel.BackgroundTransparency = 1
            for _, child in ipairs(PreviewPanel:GetDescendants()) do
                if child:IsA("TextLabel") then
                    child.TextTransparency = 1
                elseif child:IsA("ImageLabel") then
                    child.ImageTransparency = 1
                elseif child:IsA("Frame") and child.Name ~= "Glow" then
                    child.BackgroundTransparency = 1
                elseif child:IsA("UIStroke") then
                    child.Transparency = 1
                end
            end
            
            task.wait(0.15)
            updatePreviewPosition()
            tween(PreviewPanel, {BackgroundTransparency = 0.15}, 0.3)
            for _, child in ipairs(PreviewPanel:GetDescendants()) do
                if child:IsA("TextLabel") then
                    tween(child, {TextTransparency = 0}, 0.3)
                elseif child:IsA("ImageLabel") then
                    if child.Name == "Glow" then
                        tween(child, {ImageTransparency = 0.7}, 0.3)
                    else
                        tween(child, {ImageTransparency = 0}, 0.3)
                    end
                elseif child:IsA("Frame") then
                    if child.Name == "PreviewHeader" then
                        tween(child, {BackgroundTransparency = 0.2}, 0.3)
                    elseif child.Name == "PreviewDivider" then
                        tween(child, {BackgroundTransparency = 0.5}, 0.3)
                    elseif child.Name == "AvatarImageContainer" then
                        tween(child, {BackgroundTransparency = 0.3}, 0.3)
                    end
                elseif child:IsA("UIStroke") then
                    local originalTransparency = 0.3
                    if child.Parent == PreviewPanel then
                        originalTransparency = 0.3
                    elseif child.Parent.Name == "AvatarImageContainer" then
                        originalTransparency = 0.6
                    end
                    tween(child, {Transparency = originalTransparency}, 0.3)
                end
            end
        end
        
        tween(ToggleVisibilityBtn, {BackgroundColor3 = Color3.fromRGB(45, 45, 60)}, 0.3)
        tween(ToggleBtnStroke, {Color = Color3.fromRGB(120, 140, 255)}, 0.3)
        ToggleBtnGlow.ImageColor3 = Color3.fromRGB(120, 140, 255)
        
        task.wait(0.4)
    end
    tween(ToggleVisibilityBtn, {Size = UDim2.new(0, 62, 0, 62)}, 0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    task.wait(0.1)
    tween(ToggleVisibilityBtn, {Size = UDim2.new(0, 55, 0, 55)}, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    
    isTogglingVisibility = false
end
trackConnection(ToggleVisibilityBtn.MouseEnter:Connect(function()
    if not toggleDragging and not isTogglingVisibility then
        tween(ToggleVisibilityBtn, {Size = UDim2.new(0, 60, 0, 60)}, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        tween(ToggleBtnStroke, {Thickness = 3}, 0.2)
        tween(ToggleBtnGlow, {ImageTransparency = 0.4}, 0.2)
    end
end))

trackConnection(ToggleVisibilityBtn.MouseButton1Click:Connect(function()
    toggleUIVisibility()
end))

trackConnection(ToggleVisibilityBtn.MouseLeave:Connect(function()
    if not toggleDragging and not isTogglingVisibility then
        tween(ToggleVisibilityBtn, {Size = UDim2.new(0, 55, 0, 55)}, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
        tween(ToggleBtnStroke, {Thickness = 2.5}, 0.2)
        tween(ToggleBtnGlow, {ImageTransparency = 0.6}, 0.2)
    end
end))

trackConnection(PreviewToggle.MouseButton1Click:Connect(function()
    settings.showPreview = not settings.showPreview
    safeWrite(settings)
    PreviewPanel.Visible = settings.showPreview
    
    if settings.showPreview then
        PreviewToggle.BackgroundColor3 = Color3.fromRGB(120, 140, 255)
        updatePreviewPosition()
        loadPreview(Input.Text)
    else
        PreviewToggle.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
        if currentPreviewThread then
            pcall(function() task.cancel(currentPreviewThread) end)
            currentPreviewThread = nil
        end
    end
end))

trackConnection(Frame:GetPropertyChangedSignal("Position"):Connect(function()
    if settings.showPreview and PreviewPanel.Visible and not settings.uiHidden then
        updatePreviewPosition()
    end
end))

trackConnection(workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(function()
    ensureUIInBounds(Frame, true)
    if settings.showPreview and PreviewPanel.Visible and not settings.uiHidden then
        updatePreviewPosition()
    end
end))

trackConnection(Input.FocusLost:Connect(function()
    settings.target = Input.Text
    safeWrite(settings)
    if settings.showPreview and PreviewPanel.Visible then
        loadPreview(Input.Text)
    end
end))

-- ============================================
-- DRAGGING FUNCTIONALITY
-- ============================================

local dragging, dragStart, startPos, dragConnection

local function updateDrag(input)
    local delta = input.Position - dragStart
    local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    
    local viewportSize = workspace.CurrentCamera.ViewportSize
    local frameSize = Frame.AbsoluteSize
    
    local posX = newPos.X.Scale * viewportSize.X + newPos.X.Offset
    local posY = newPos.Y.Scale * viewportSize.Y + newPos.Y.Offset
    
    if posX < SCREEN_PADDING then
        posX = SCREEN_PADDING
    elseif posX + frameSize.X > viewportSize.X - SCREEN_PADDING then
        posX = viewportSize.X - frameSize.X - SCREEN_PADDING
    end
    
    if posY < SCREEN_PADDING then
        posY = SCREEN_PADDING
    elseif posY + frameSize.Y > viewportSize.Y - SCREEN_PADDING then
        posY = viewportSize.Y - frameSize.Y - SCREEN_PADDING
    end
    
    newPos = UDim2.new(0, posX, 0, posY)
    Frame.Position = newPos
end

trackConnection(TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        
        if dragConnection then 
            pcall(function() dragConnection:Disconnect() end)
        end
        dragConnection = trackConnection(input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
                ensureUIInBounds(Frame, true)
                local pos = Frame.Position
                settings.uiPos = {x = pos.X.Scale, offsetX = pos.X.Offset, y = pos.Y.Scale, offsetY = pos.Y.Offset}
                safeWrite(settings)
            end
        end))
    end
end))

trackConnection(UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        updateDrag(input)
    end
end))

-- ============================================
-- MINIMIZE FUNCTIONALITY
-- ============================================

local minimizedHeight = 32
local minimizeDebounce = false

local function animateMiniButton()
    local originalPos = Mini.Position
    local originalColor = Mini.BackgroundColor3
    Mini.BackgroundColor3 = Color3.fromRGB(80, 255, 120)
    tween(Mini, {Position=originalPos + UDim2.new(0,0,0,-6)},0.12)
    task.wait(0.12)
    tween(Mini, {Position=originalPos},0.12)
    task.wait(0.12)
    Mini.BackgroundColor3 = originalColor
end

local function applyMinimized(state)
    if minimizeDebounce then return end
    minimizeDebounce = true
    settings.minimized = state
    safeWrite(settings)
    Mini.Text = state and "+" or "-"
    
    task.spawn(function() animateMiniButton() end)
    
    if state then
        for _,v in ipairs(Frame:GetChildren()) do
            if v ~= TitleBar and v.Name ~= "Glow" and not v:IsA("UICorner") and not v:IsA("UIStroke") then
                v.Visible = false
            end
        end
        tween(Frame, {Size=UDim2.new(0, settings.uiSize.x, 0, minimizedHeight)},0.25)
        task.delay(0.25, function() 
            minimizeDebounce = false
            ensureUIInBounds(Frame, true)
        end)
    else
        tween(Frame, {Size=UDim2.new(0, settings.uiSize.x, 0, settings.uiSize.y)},0.25)
        task.delay(0.25,function()
            for _,v in ipairs(Frame:GetChildren()) do
                if v ~= TitleBar and v.Name ~= "Glow" and not v:IsA("UICorner") and not v:IsA("UIStroke") then
                    v.Visible = true
                    if v:IsA("TextBox") or v:IsA("TextLabel") or v:IsA("TextButton") then
                        v.TextTransparency = 1
                        tween(v, {TextTransparency=0},0.25)
                    end
                end
            end
            minimizeDebounce = false
            ensureUIInBounds(Frame, true)
        end)
    end
end

trackConnection(Mini.MouseButton1Click:Connect(function()
    applyMinimized(not settings.minimized)
end))

-- ============================================
-- CHARACTER CLEANING FUNCTIONS
-- ============================================

local function deepCleanCharacter(character, targetUserId)
    if currentAppliedUserId == targetUserId then
        return
    end
    if targetUserId == LocalPlayer.UserId and not currentAppliedUserId then
        return
    end
    for _, child in ipairs(character:GetChildren()) do
        pcall(function()
            if child:IsA("Accessory") or child:IsA("Hat") then
                child:Destroy()
            elseif child:IsA("Shirt") or child:IsA("Pants") or child:IsA("ShirtGraphic") then
                child:Destroy()
            elseif child:IsA("BodyColors") then
                child:Destroy()
            elseif child:IsA("CharacterMesh") then
                child:Destroy()
            end
        end)
    end
end

local function loadAsset(assetId)
    local success, model = pcall(function()
        return InsertService:LoadAsset(assetId)
    end)
    if success and model then
        return model:GetChildren()[1]
    end
    return nil
end

local function getDescriptionWithCache(userId)
    local now = tick()
    
    if descriptionCache[userId] and lastFetchTime[userId] then
        if (now - lastFetchTime[userId]) < FETCH_COOLDOWN then
            return descriptionCache[userId]
        end
    end
    
    local ok, desc = pcall(function() 
        return Players:GetHumanoidDescriptionFromUserId(userId) 
    end)
    
    if ok and desc then
        descriptionCache[userId] = desc
        lastFetchTime[userId] = now
        
        local cacheCount = 0
        for _ in pairs(descriptionCache) do
            cacheCount = cacheCount + 1
        end
        
        if cacheCount > MAX_CACHE_SIZE then
            local oldestId = nil
            local oldestTime = math.huge
            for id, time in pairs(lastFetchTime) do
                if time < oldestTime then
                    oldestTime = time
                    oldestId = id
                end
            end
            if oldestId then
                descriptionCache[oldestId] = nil
                lastFetchTime[oldestId] = nil
            end
        end
        
        return desc
    end
    
    return nil
end

-- ============================================
-- AVATAR APPLICATION LOGIC
-- ============================================

local ReapplyConnection = nil
local buttonDebounce = false

local function applyAvatarToCharacter(targetText, character)
    if isApplying then 
        setStatus("wait")
        return false 
    end
    
    local userId = ResolveUserId(targetText)
    if not userId then 
        setStatus("not_found")
        task.wait(1.5)
        setStatus("ready")
        return false 
    end
    
    if currentAppliedUserId == userId then
        setStatus("already")
        task.wait(0.5)
        if settings.enabled then
            setStatus("auto_active")
        else
            setStatus("ready")
        end
        return false
    end
    
    isApplying = true
    setStatus("fetching")
    
    local desc = getDescriptionWithCache(userId)
    if not desc then 
        setStatus("fetch_failed")
        task.wait(1.5)
        setStatus("ready")
        isApplying = false
        return false 
    end

    if not character:FindFirstChild("HumanoidRootPart") then
        character:WaitForChild("HumanoidRootPart", 5)
    end
    
    local hum = character:FindFirstChildOfClass("Humanoid")
    if not hum then
        hum = character:WaitForChild("Humanoid", 5)
    end
    
    if not hum then 
        setStatus("no_humanoid")
        task.wait(1.5)
        setStatus("ready")
        isApplying = false
        return false 
    end

    setStatus("cleaning")
    deepCleanCharacter(character, userId)
    task.wait(0.1)

    setStatus("applying")
    
    local targetFace = desc.Face
    local shouldChangeFace = needsFaceUpdate(character, targetFace)
    
    local applySuccess = false
    for i = 1, 2 do
        local success = pcall(function()
            if hum.ApplyDescriptionClientServer then
                hum:ApplyDescriptionClientServer(desc)
                applySuccess = true
            elseif hum.ApplyDescription then
                hum:ApplyDescription(desc)
                applySuccess = true
            end
        end)
        if applySuccess then break end
        task.wait(0.05)
    end
    
    if shouldChangeFace then
        task.wait(0.1)
        applyFace(character, targetFace, 2)
    end
    
    task.wait(0.15)
    
    pcall(function()
        if desc.Shirt and desc.Shirt ~= "" and tonumber(desc.Shirt) and tonumber(desc.Shirt) > 0 then
            local shirt = Instance.new("Shirt")
            shirt.ShirtTemplate = "rbxassetid://" .. desc.Shirt
            shirt.Parent = character
        end
        
        if desc.Pants and desc.Pants ~= "" and tonumber(desc.Pants) and tonumber(desc.Pants) > 0 then
            local pants = Instance.new("Pants")
            pants.PantsTemplate = "rbxassetid://" .. desc.Pants
            pants.Parent = character
        end
        
        if desc.GraphicTShirt and desc.GraphicTShirt ~= "" and tonumber(desc.GraphicTShirt) and tonumber(desc.GraphicTShirt) > 0 then
            local graphic = Instance.new("ShirtGraphic")
            graphic.Graphic = "rbxassetid://" .. desc.GraphicTShirt
            graphic.Parent = character
        end
        
        local bodyColors = character:FindFirstChildOfClass("BodyColors") or Instance.new("BodyColors")
        bodyColors.HeadColor3 = desc.HeadColor
        bodyColors.TorsoColor3 = desc.TorsoColor
        bodyColors.LeftArmColor3 = desc.LeftArmColor
        bodyColors.RightArmColor3 = desc.RightArmColor
        bodyColors.LeftLegColor3 = desc.LeftLegColor
        bodyColors.RightLegColor3 = desc.RightLegColor
        bodyColors.Parent = character
    end)
    
    setStatus("accessories")
    
    local accessoryList = {}
    pcall(function()
        if desc.HatAccessory and desc.HatAccessory ~= "" then table.insert(accessoryList, desc.HatAccessory) end
        if desc.HairAccessory and desc.HairAccessory ~= "" then table.insert(accessoryList, desc.HairAccessory) end
        if desc.FaceAccessory and desc.FaceAccessory ~= "" then table.insert(accessoryList, desc.FaceAccessory) end
        if desc.NeckAccessory and desc.NeckAccessory ~= "" then table.insert(accessoryList, desc.NeckAccessory) end
        if desc.ShoulderAccessory and desc.ShoulderAccessory ~= "" then table.insert(accessoryList, desc.ShoulderAccessory) end
        if desc.FrontAccessory and desc.FrontAccessory ~= "" then table.insert(accessoryList, desc.FrontAccessory) end
        if desc.BackAccessory and desc.BackAccessory ~= "" then table.insert(accessoryList, desc.BackAccessory) end
        if desc.WaistAccessory and desc.WaistAccessory ~= "" then table.insert(accessoryList, desc.WaistAccessory) end
    end)
    
    local loadedCount = 0
    for _, accessoryId in ipairs(accessoryList) do
        task.spawn(function()
            pcall(function()
                local assetId = tonumber(accessoryId)
                if assetId and assetId > 0 then
                    local accessory = loadAsset(assetId)
                    if accessory and accessory:IsA("Accessory") then
                        accessory.Parent = character
                        if hum then
                            task.wait(0.03)
                            pcall(function()
                                hum:AddAccessory(accessory)
                            end)
                        end
                        loadedCount = loadedCount + 1
                    end
                end
            end)
        end)
    end
    
    task.wait(0.5)
    
    pcall(function()
        if hum.ApplyDescriptionClientServer then
            hum:ApplyDescriptionClientServer(desc)
        elseif hum.ApplyDescription then
            hum:ApplyDescription(desc)
        end
    end)
    
    if shouldChangeFace then
        task.wait(0.2)
        applyFace(character, targetFace, 2)
    end

    currentAppliedUserId = userId
    lastApplicationTime = tick()

    setStatus("success", "Avatar Applied! (" .. loadedCount .. " accessories)")
    task.wait(0.5)
    
    task.spawn(function()
        if settings.enabled then
            setStatus("auto_active")
        else
            setStatus("ready")
        end
    end)
    
    isApplying = false
    return true
end

-- ============================================
-- TOGGLE FUNCTIONS
-- ============================================

local function updateToggleVisual(state)
    ToggleBtn.Text = state and "On" or "Off"
    ToggleBtn.BackgroundColor3 = state and Color3.fromRGB(0,160,60) or Color3.fromRGB(160,0,0)
end

local function SetToggle(state)
    settings.enabled = state
    PersistToggle.Text = state and "Enabled" or "Disabled"
    PersistToggle.BackgroundColor3 = state and Color3.fromRGB(0,160,60) or Color3.fromRGB(160,0,0)
    safeWrite(settings)
    updateToggleVisual(state)

    if state then
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then 
            task.wait(0.3)
            pcall(function() applyAvatarToCharacter(Input.Text, LocalPlayer.Character) end) 
        end
        if ReapplyConnection then 
            pcall(function() ReapplyConnection:Disconnect() end)
        end
        ReapplyConnection = trackConnection(LocalPlayer.CharacterAdded:Connect(function(char)
            currentAppliedUserId = nil
            lastApplicationTime = 0
            isApplying = false
            lastRequestedUserId = nil
            
            char:WaitForChild("HumanoidRootPart", 10)
            task.wait(1.2)
            if settings.enabled and Input.Text ~= "" then 
                applyAvatarToCharacter(Input.Text, char) 
            end
        end))
        setStatus("auto_active")
    else
        if ReapplyConnection then 
            pcall(function() ReapplyConnection:Disconnect() end)
            for i, conn in ipairs(connections) do
                if conn == ReapplyConnection then
                    table.remove(connections, i)
                    break
                end
            end
        end
        ReapplyConnection = nil
        
        currentAppliedUserId = nil
        lastRequestedUserId = nil
        lastApplicationTime = 0
        
        if LocalPlayer.Character then
            task.spawn(function()
                pcall(function()
deepCleanCharacter(LocalPlayer.Character, LocalPlayer.UserId)
                    task.wait(0.2)
                    
                    local ok, desc = pcall(function() 
                        return Players:GetHumanoidDescriptionFromUserId(LocalPlayer.UserId) 
                    end)
                    if ok and desc then
                        local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                        if hum then
                            for i = 1, 3 do
                                if hum.ApplyDescriptionClientServer then 
                                    hum:ApplyDescriptionClientServer(desc)
                                elseif hum.ApplyDescription then
                                    hum:ApplyDescription(desc)
                                end
                                task.wait(0.3)
                            end
                        end
                    end
                end)
            end)
        end
        setStatus("ready")
    end
end

-- ============================================
-- BUTTON CLICK EVENTS
-- ============================================

trackConnection(ApplyBtn.MouseButton1Click:Connect(function()
    if isApplying then
        setStatus("wait")
        return
    end
    
    if buttonDebounce then 
        return 
    end
    buttonDebounce = true
    
    if Input.Text == "" then 
        setStatus("no_target")
        task.wait(1.5)
        setStatus("ready")
        buttonDebounce = false
        return 
    end
    
    local userId = ResolveUserId(Input.Text)
    if not userId then
        setStatus("invalid")
        task.wait(1.5)
        setStatus("ready")
        buttonDebounce = false
        return
    end
    
    if lastRequestedUserId == userId or currentAppliedUserId == userId then
        setStatus("already")
        task.wait(0.8)
        if settings.enabled then
            setStatus("auto_active")
        else
            setStatus("ready")
        end
        buttonDebounce = false
        return
    end
    
    lastRequestedUserId = userId
    
    settings.target = Input.Text
    safeWrite(settings)
    
    if LocalPlayer.Character then
        applyAvatarToCharacter(Input.Text, LocalPlayer.Character)
    end
    
    task.delay(0.5, function()
        buttonDebounce = false
    end)
end))

trackConnection(PersistToggle.MouseButton1Click:Connect(function()
    if isApplying then
        setStatus("wait")
        return
    end
    
    if buttonDebounce then 
        return 
    end
    buttonDebounce = true
    
    if Input.Text == "" then
        setStatus("no_target")
        task.wait(1.5)
        setStatus("ready")
        buttonDebounce = false
        return
    end
    
    if not settings.enabled then
        local userId = ResolveUserId(Input.Text)
        if userId and currentAppliedUserId == userId and (tick() - lastApplicationTime) < APPLICATION_COOLDOWN then
            setStatus("already")
            task.wait(1.5)
            setStatus("ready")
            buttonDebounce = false
            return
        end
    end
    
    settings.target = Input.Text
    safeWrite(settings)
    SetToggle(not settings.enabled)
    
    task.delay(0.5, function()
        buttonDebounce = false
    end)
end))

trackConnection(ToggleBtn.MouseButton1Click:Connect(function()
    if isApplying then
        setStatus("wait")
        return
    end
    
    if buttonDebounce then 
        return 
    end
    buttonDebounce = true
    
    if Input.Text == "" then
        setStatus("no_target")
        task.wait(1.5)
        setStatus("ready")
        buttonDebounce = false
        return
    end
    
    if not settings.enabled then
        local userId = ResolveUserId(Input.Text)
        if userId and currentAppliedUserId == userId and (tick() - lastApplicationTime) < APPLICATION_COOLDOWN then
            setStatus("already")
            task.wait(1.5)
            setStatus("ready")
            buttonDebounce = false
            return
        end
    end
    
    settings.target = Input.Text
    safeWrite(settings)
    SetToggle(not settings.enabled)
    
    task.delay(0.5, function()
        buttonDebounce = false
    end)
end))

-- ============================================
-- INITIALIZATION
-- ============================================

updateToggleVisual(settings.enabled)
PersistToggle.Text = settings.enabled and "Enabled" or "Disabled"
PersistToggle.BackgroundColor3 = settings.enabled and Color3.fromRGB(0,160,60) or Color3.fromRGB(160,0,0)

if settings.minimized then
    applyMinimized(true)
end
if settings.uiHidden then
    local safeX = settings.uiPos and settings.uiPos.x or 1
    local safeOffsetX = settings.uiPos and settings.uiPos.offsetX or -280
    local safeY = settings.uiPos and settings.uiPos.y or 0
    local safeOffsetY = settings.uiPos and settings.uiPos.offsetY or 20
    
    Frame.Position = UDim2.new(safeX, safeOffsetX, safeY, safeOffsetY)
    Frame.Visible = false
    PreviewPanel.Visible = false
    ToggleBtnIcon.Text = "üëÅ‚Äçüó®"
    ToggleVisibilityBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 100)
    ToggleBtnStroke.Color = Color3.fromRGB(255, 100, 120)
    ToggleBtnGlow.ImageColor3 = Color3.fromRGB(255, 100, 120)
else
    if settings.showPreview then
        PreviewPanel.Visible = true
        PreviewToggle.BackgroundColor3 = Color3.fromRGB(120, 140, 255)
        updatePreviewPosition()
        loadPreview(Input.Text)
    end
end

task.spawn(function()
    task.wait(0.1)
    if not settings.uiHidden then
        ensureUIInBounds(Frame, false)
        if settings.showPreview and PreviewPanel.Visible then
            updatePreviewPosition()
        end
    end
end)

if settings.enabled and settings.target ~= "" then
    Input.Text = settings.target
    SetToggle(true)
else
    setStatus("ready")
end

-- ============================================
-- CLEANUP CONNECTIONS
-- ============================================

trackConnection(Players.PlayerRemoving:Connect(function(plr)
    if plr == LocalPlayer then
        cleanupAll()
    end
end))

if script then
    trackConnection(script.AncestryChanged:Connect(function()
        if not script:IsDescendantOf(game) then
            cleanupAll()
        end
    end))
end

trackConnection(gui.AncestryChanged:Connect(function()
    if not gui:IsDescendantOf(game) then
        cleanupAll()
    end
end))
