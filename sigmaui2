local get = setmetatable({}, {
    __index = function(a, b)
        return game:GetService(b) or game[b]
    end
})

local player = get.Players.LocalPlayer
local findobj, findobjofclass, waitforobj = get.FindFirstChild, get.FindFirstChildOfClass, get.WaitForChild

-- Wait for essentials
repeat wait() until player:FindFirstChild("PlayerFolder")
print("PlayerFolder loaded")

local team = player.PlayerFolder.Customization.Team.Value
local remotes = get.ReplicatedStorage.Remotes
local stat = player.PlayerFolder.StatsFunction

print("Team: " .. team)

-- Enhanced Config
local Config = {
    Farming = false,
    NPCTargets = {},
    BossTargets = {},
    TeleportSpeed = 150,
    NPCDistance = 5,
    BossDistance = 8,
    Stage = "One",
    UseSkills = true,
    AutoCollectRewards = true,
    SafeMode = true,
    SafeHealthPercent = 30,
    Skills = {
        E = false,
        R = false,
        F = false,
        C = false
    }
}

-- Boss Data
local Bosses = {
    {Name = "Nishiki Nishio", Level = 250, Spawn = "NishikiSpawn"},
    {Name = "Koutarou Amon", Level = 750, Spawn = "AmonSpawn"},
    {Name = "Eto Yoshimura", Level = 1250, Spawn = "EtoSpawn"},
    {Name = "Gyakusatsu", Level = 1250, Spawn = "GyakusatsuSpawn"}
}

local NPCTypes = {
    {Name = "Aogiri Members", Spawn = "GhoulSpawns"},
    {Name = "Investigators", Spawn = "CCGSpawns"}, 
    {Name = "Humans", Spawn = "HumanSpawns"}
}

local SkillCDs = {
    E = player.PlayerFolder.Special1CD,
    R = player.PlayerFolder.Special2CD,
    F = player.PlayerFolder.Special3CD,
    C = player.PlayerFolder.SpecialBonusCD
}

-- State
local key = nil
local CurrentTarget = "None"
local DebugText = "Initializing..."
local Stats = {
    Kills = 0,
    Deaths = 0,
    Yen = 0,
    RC = 0,
    StartTime = tick()
}

-- Modern UI Library
local UILibrary = {}
UILibrary.__index = UILibrary

function UILibrary:Create()
    local library = setmetatable({}, UILibrary)
    
    -- Detect platform
    local UserInputService = get.UserInputService
    library.IsMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
    
    -- Create ScreenGui
    library.ScreenGui = Instance.new("ScreenGui")
    library.ScreenGui.Name = "RoGhoulUI"
    library.ScreenGui.ResetOnSpawn = false
    library.ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    library.ScreenGui.Parent = get.CoreGui
    
    return library
end

function UILibrary:CreateWindow(title)
    local window = {}
    
    -- Calculate responsive size
    local screenSize = workspace.CurrentCamera.ViewportSize
    local windowWidth = self.IsMobile and math.min(screenSize.X * 0.95, 400) or 550
    local windowHeight = self.IsMobile and math.min(screenSize.Y * 0.85, 600) or 500
    
    -- Main Frame
    window.Main = Instance.new("Frame")
    window.Main.Name = "MainWindow"
    window.Main.Size = UDim2.new(0, windowWidth, 0, windowHeight)
    window.Main.Position = UDim2.new(0.5, -windowWidth/2, 0.5, -windowHeight/2)
    window.Main.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    window.Main.BorderSizePixel = 0
    window.Main.Active = true
    window.Main.Parent = self.ScreenGui
    
    -- Corner
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = window.Main
    
    -- Shadow effect
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.BackgroundTransparency = 1
    shadow.Position = UDim2.new(0, -15, 0, -15)
    shadow.Size = UDim2.new(1, 30, 1, 30)
    shadow.ZIndex = 0
    shadow.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
    shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    shadow.ImageTransparency = 0.5
    shadow.Parent = window.Main
    
    -- Title Bar
    window.TitleBar = Instance.new("Frame")
    window.TitleBar.Name = "TitleBar"
    window.TitleBar.Size = UDim2.new(1, 0, 0, 40)
    window.TitleBar.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
    window.TitleBar.BorderSizePixel = 0
    window.TitleBar.Parent = window.Main
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 12)
    titleCorner.Parent = window.TitleBar
    
    -- Cover bottom corners of title
    local titleCover = Instance.new("Frame")
    titleCover.Size = UDim2.new(1, 0, 0, 12)
    titleCover.Position = UDim2.new(0, 0, 1, -12)
    titleCover.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
    titleCover.BorderSizePixel = 0
    titleCover.Parent = window.TitleBar
    
    -- Title Text
    window.TitleText = Instance.new("TextLabel")
    window.TitleText.Size = UDim2.new(1, -50, 1, 0)
    window.TitleText.Position = UDim2.new(0, 15, 0, 0)
    window.TitleText.BackgroundTransparency = 1
    window.TitleText.Text = "â–¼ " .. title
    window.TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    window.TitleText.TextSize = self.IsMobile and 16 or 18
    window.TitleText.Font = Enum.Font.GothamBold
    window.TitleText.TextXAlignment = Enum.TextXAlignment.Left
    window.TitleText.Parent = window.TitleBar
    
    -- Close/Hide Button
    window.CloseBtn = Instance.new("TextButton")
    window.CloseBtn.Size = UDim2.new(0, 30, 0, 30)
    window.CloseBtn.Position = UDim2.new(1, -35, 0, 5)
    window.CloseBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    window.CloseBtn.Text = "âˆ’"
    window.CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    window.CloseBtn.TextSize = 24
    window.CloseBtn.Font = Enum.Font.GothamBold
    window.CloseBtn.Parent = window.TitleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = window.CloseBtn
    
    window.IsHidden = false
    
    window.CloseBtn.MouseButton1Click:Connect(function()
        window.IsHidden = not window.IsHidden
        
        if window.IsHidden then
            -- Hide UI
            window.TabContainer.Visible = false
            window.ContentContainer.Visible = false
            get.TweenService:Create(window.Main, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
                Size = UDim2.new(0, windowWidth, 0, 40)
            }):Play()
            window.CloseBtn.Text = "+"
            window.TitleText.Text = "â–¶ " .. title
        else
            -- Show UI
            window.TabContainer.Visible = true
            window.ContentContainer.Visible = true
            get.TweenService:Create(window.Main, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
                Size = UDim2.new(0, windowWidth, 0, windowHeight)
            }):Play()
            window.CloseBtn.Text = "âˆ’"
            window.TitleText.Text = "â–¼ " .. title
        end
    end)
    
    -- Tab Container
    window.TabContainer = Instance.new("Frame")
    window.TabContainer.Name = "TabContainer"
    window.TabContainer.Size = UDim2.new(1, 0, 0, 35)
    window.TabContainer.Position = UDim2.new(0, 0, 0, 40)
    window.TabContainer.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    window.TabContainer.BorderSizePixel = 0
    window.TabContainer.Parent = window.Main
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.FillDirection = Enum.FillDirection.Horizontal
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 2)
    tabLayout.Parent = window.TabContainer
    
    -- Content Container
    window.ContentContainer = Instance.new("Frame")
    window.ContentContainer.Name = "Content"
    window.ContentContainer.Size = UDim2.new(1, -20, 1, -95)
    window.ContentContainer.Position = UDim2.new(0, 10, 0, 85)
    window.ContentContainer.BackgroundTransparency = 1
    window.ContentContainer.Parent = window.Main
    
    -- Make draggable
    self:MakeDraggable(window.Main, window.TitleBar)
    
    -- Auto resize on screen change
    workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(function()
        local newScreenSize = workspace.CurrentCamera.ViewportSize
        local newWidth = self.IsMobile and math.min(newScreenSize.X * 0.95, 400) or 550
        local newHeight = self.IsMobile and math.min(newScreenSize.Y * 0.85, 600) or 500
        window.Main.Size = UDim2.new(0, newWidth, 0, newHeight)
        window.Main.Position = UDim2.new(0.5, -newWidth/2, 0.5, -newHeight/2)
    end)
    
    window.Tabs = {}
    window.CurrentTab = nil
    window.Library = self
    
    return window
end

function UILibrary:MakeDraggable(frame, dragHandle)
    local dragging = false
    local dragInput, mousePos, framePos
    
    local function update(input)
        local delta = input.Position - mousePos
        frame.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
    end
    
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            mousePos = input.Position
            framePos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    get.UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

function UILibrary:CreateTab(window, name)
    local tab = {}
    
    -- Calculate tab width dynamically
    local tabWidth = window.Library.IsMobile and 80 or 100
    
    -- Tab Button
    tab.Button = Instance.new("TextButton")
    tab.Button.Size = UDim2.new(0, tabWidth, 1, 0)
    tab.Button.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    tab.Button.Text = name
    tab.Button.TextColor3 = Color3.fromRGB(180, 180, 180)
    tab.Button.TextSize = window.Library.IsMobile and 13 or 14
    tab.Button.Font = Enum.Font.GothamSemibold
    tab.Button.BorderSizePixel = 0
    tab.Button.Parent = window.TabContainer
    
    -- Tab Content
    tab.Content = Instance.new("ScrollingFrame")
    tab.Content.Name = name .. "Content"
    tab.Content.Size = UDim2.new(1, 0, 1, 0)
    tab.Content.BackgroundTransparency = 1
    tab.Content.BorderSizePixel = 0
    tab.Content.ScrollBarThickness = 4
    tab.Content.ScrollBarImageColor3 = Color3.fromRGB(220, 20, 60)
    tab.Content.Visible = false
    tab.Content.Parent = window.ContentContainer
    tab.Content.CanvasSize = UDim2.new(0, 0, 0, 0)
    
    -- Auto-sizing
    local contentLayout = Instance.new("UIListLayout")
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Padding = UDim.new(0, 8)
    contentLayout.Parent = tab.Content
    
    contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        tab.Content.CanvasSize = UDim2.new(0, 0, 0, contentLayout.AbsoluteContentSize.Y + 10)
    end)
    
    -- Tab switching
    tab.Button.MouseButton1Click:Connect(function()
        for _, otherTab in pairs(window.Tabs) do
            otherTab.Content.Visible = false
            otherTab.Button.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
            otherTab.Button.TextColor3 = Color3.fromRGB(180, 180, 180)
        end
        
        tab.Content.Visible = true
        tab.Button.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
        tab.Button.TextColor3 = Color3.fromRGB(255, 255, 255)
        window.CurrentTab = tab
    end)
    
    table.insert(window.Tabs, tab)
    
    if #window.Tabs == 1 then
        task.wait(0.1)
        for _, otherTab in pairs(window.Tabs) do
            otherTab.Content.Visible = false
            otherTab.Button.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
            otherTab.Button.TextColor3 = Color3.fromRGB(180, 180, 180)
        end
        
        tab.Content.Visible = true
        tab.Button.BackgroundColor3 = Color3.fromRGB(220, 20, 60)
        tab.Button.TextColor3 = Color3.fromRGB(255, 255, 255)
        window.CurrentTab = tab
    end
    
    tab.Window = window
    return tab
end

function UILibrary:CreateLabel(tab, text)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -10, 0, 25)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(220, 220, 220)
    label.TextSize = tab.Window.Library.IsMobile and 13 or 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = tab.Content
    
    return {Text = text, Element = label, Set = function(self, newText) label.Text = newText end}
end

function UILibrary:CreateButton(tab, text, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, -10, 0, 35)
    button.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    button.Text = text
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = tab.Window.Library.IsMobile and 13 or 14
    button.Font = Enum.Font.GothamSemibold
    button.Parent = tab.Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(callback)
    
    -- Hover effect
    button.MouseEnter:Connect(function()
        button.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    end)
    
    button.MouseLeave:Connect(function()
        button.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    end)
    
    return {Text = text, Element = button}
end

function UILibrary:CreateToggle(tab, text, default, callback)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, -10, 0, 35)
    container.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    container.Parent = tab.Content
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = container
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -50, 1, 0)
    label.Position = UDim2.new(0, 10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(220, 220, 220)
    label.TextSize = tab.Window.Library.IsMobile and 13 or 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container
    
    local toggle = Instance.new("TextButton")
    toggle.Size = UDim2.new(0, 40, 0, 20)
    toggle.Position = UDim2.new(1, -45, 0.5, -10)
    toggle.BackgroundColor3 = default and Color3.fromRGB(220, 20, 60) or Color3.fromRGB(60, 60, 70)
    toggle.Text = ""
    toggle.Parent = container
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(1, 0)
    toggleCorner.Parent = toggle
    
    local indicator = Instance.new("Frame")
    indicator.Size = UDim2.new(0, 16, 0, 16)
    indicator.Position = default and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
    indicator.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    indicator.Parent = toggle
    
    local indicatorCorner = Instance.new("UICorner")
    indicatorCorner.CornerRadius = UDim.new(1, 0)
    indicatorCorner.Parent = indicator
    
    local state = default or false
    
    toggle.MouseButton1Click:Connect(function()
        state = not state
        callback(state)
        
        get.TweenService:Create(toggle, TweenInfo.new(0.2), {
            BackgroundColor3 = state and Color3.fromRGB(220, 20, 60) or Color3.fromRGB(60, 60, 70)
        }):Play()
        
        get.TweenService:Create(indicator, TweenInfo.new(0.2), {
            Position = state and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
        }):Play()
    end)
    
    return {
        State = state,
        Element = container,
        Set = function(self, newState)
            if state ~= newState then
                state = not state
                callback(state)
                
                get.TweenService:Create(toggle, TweenInfo.new(0.2), {
                    BackgroundColor3 = state and Color3.fromRGB(220, 20, 60) or Color3.fromRGB(60, 60, 70)
                }):Play()
                
                get.TweenService:Create(indicator, TweenInfo.new(0.2), {
                    Position = state and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
                }):Play()
            end
        end
    }
end

-- Create UI
local lib = UILibrary:Create()
local window = lib:CreateWindow("Made By Zgg4")

local farmTab = lib:CreateTab(window, "Farm")
local combatTab = lib:CreateTab(window, "Combat")
local statsTab = lib:CreateTab(window, "Stats")
local debugTab = lib:CreateTab(window, "Debug")

-- Farm Tab
lib:CreateLabel(farmTab, "â• FARM STATUS â•")
local statusLabel = lib:CreateLabel(farmTab, "â— Status: Idle")
local targetLabel = lib:CreateLabel(farmTab, "â— Target: None")
local levelLabel = lib:CreateLabel(farmTab, "â— Level: " .. player.PlayerFolder.Stats.Level.Value)

lib:CreateLabel(farmTab, " ")
lib:CreateLabel(farmTab, "â• NPC TARGETS â•")

local npcToggles = {}
for _, npcType in ipairs(NPCTypes) do
    npcToggles[npcType.Name] = lib:CreateToggle(farmTab, npcType.Name, false, function(state)
        if state then
            table.insert(Config.NPCTargets, npcType.Spawn)
        else
            for i, spawn in ipairs(Config.NPCTargets) do
                if spawn == npcType.Spawn then
                    table.remove(Config.NPCTargets, i)
                    break
                end
            end
        end
    end)
end

lib:CreateButton(farmTab, "Select All NPCs", function()
    for _, toggle in pairs(npcToggles) do
        toggle:Set(true)
    end
end)

lib:CreateButton(farmTab, "Deselect All NPCs", function()
    for _, toggle in pairs(npcToggles) do
        toggle:Set(false)
    end
end)

lib:CreateLabel(farmTab, " ")
lib:CreateLabel(farmTab, "â• BOSS TARGETS â•")

local bossToggles = {}
for _, boss in ipairs(Bosses) do
    bossToggles[boss.Name] = lib:CreateToggle(farmTab, boss.Name .. " [" .. boss.Level .. "]", false, function(state)
        if state then
            table.insert(Config.BossTargets, boss)
        else
            for i, b in ipairs(Config.BossTargets) do
                if b.Name == boss.Name then
                    table.remove(Config.BossTargets, i)
                    break
                end
            end
        end
    end)
end

lib:CreateButton(farmTab, "Select All Bosses", function()
    for _, toggle in pairs(bossToggles) do
        toggle:Set(true)
    end
end)

lib:CreateLabel(farmTab, " ")
lib:CreateLabel(farmTab, "â• CONTROLS â•")

local startBtn = lib:CreateButton(farmTab, "â–¶ START FARM", function()
    if not Config.Farming then
        if not key then
            statusLabel:Set("â— Status: ERROR - No Key!")
            warn("ERROR: Remote key not found")
            return
        end
        
        if #Config.NPCTargets == 0 and #Config.BossTargets == 0 then
            statusLabel:Set("â— Status: No targets!")
            warn("ERROR: Select at least one NPC or Boss")
            return
        end
        
        Config.Farming = true
        statusLabel:Set("â— Status: RUNNING")
        Stats.StartTime = tick()
        print("Auto farm started")
    else
        Config.Farming = false
        statusLabel:Set("â— Status: âœ— STOPPED")
        CurrentTarget = "None"
        print("Auto farm stopped")
    end
end)

lib:CreateButton(farmTab, "âš  EMERGENCY STOP", function()
    Config.Farming = false
    for _, toggle in pairs(npcToggles) do
        toggle:Set(false)
    end
    for _, toggle in pairs(bossToggles) do
        toggle:Set(false)
    end
    statusLabel:Set("â— Status: âš  EMERGENCY")
    CurrentTarget = "None"
    warn("âš  Emergency stop activated!")
end)

lib:CreateLabel(farmTab, " ")
lib:CreateLabel(farmTab, "â• SESSION INFO â•")
local quickKills = lib:CreateLabel(farmTab, "Kills: 0")
local quickYen = lib:CreateLabel(farmTab, "Yen: 0")
local quickRC = lib:CreateLabel(farmTab, "RC: 0")

-- Combat Tab
lib:CreateLabel(combatTab, "â• MOVEMENT â•")
lib:CreateLabel(combatTab, "Teleport Speed")
lib:CreateButton(combatTab, "Slow (100)", function() 
    Config.TeleportSpeed = 100
    print("Speed set to: 100")
end)
lib:CreateButton(combatTab, "Normal (150)", function() 
    Config.TeleportSpeed = 150
    print("Speed set to: 150")
end)
lib:CreateButton(combatTab, "Fast (200)", function() 
    Config.TeleportSpeed = 200
    print("Speed set to: 200")
end)
lib:CreateButton(combatTab, "Ultra (300)", function() 
    Config.TeleportSpeed = 300
    print("Speed set to: 300")
end)

lib:CreateLabel(combatTab, " ")
lib:CreateLabel(combatTab, "NPC Distance")
lib:CreateButton(combatTab, "Close (3)", function() 
    Config.NPCDistance = 3
    print("NPC Distance: 3")
end)
lib:CreateButton(combatTab, "Normal (5)", function() 
    Config.NPCDistance = 5
    print("NPC Distance: 5")
end)
lib:CreateButton(combatTab, "Far (8)", function() 
    Config.NPCDistance = 8
    print("NPC Distance: 8")
end)

lib:CreateLabel(combatTab, " ")
lib:CreateLabel(combatTab, "Boss Distance")
lib:CreateButton(combatTab, "Close (5)", function() 
    Config.BossDistance = 5
    print("Boss Distance: 5")
end)
lib:CreateButton(combatTab, "Normal (8)", function() 
    Config.BossDistance = 8
    print("Boss Distance: 8")
end)
lib:CreateButton(combatTab, "Far (12)", function() 
    Config.BossDistance = 12
    print("Boss Distance: 12")
end)

lib:CreateLabel(combatTab, " ")
lib:CreateLabel(combatTab, "â• COMBAT â•")
lib:CreateToggle(combatTab, "Use Skills on Bosses", true, function(state) Config.UseSkills = state end)
lib:CreateToggle(combatTab, "Safe Mode (Dodge)", true, function(state) Config.SafeMode = state end)

lib:CreateLabel(combatTab, " ")
lib:CreateLabel(combatTab, "â• SKILLS â•")
lib:CreateToggle(combatTab, "Skill E", false, function(state) Config.Skills.E = state end)
lib:CreateToggle(combatTab, "Skill R", false, function(state) Config.Skills.R = state end)
lib:CreateToggle(combatTab, "Skill F", false, function(state) Config.Skills.F = state end)
lib:CreateToggle(combatTab, "Skill C", false, function(state) Config.Skills.C = state end)

-- Stats Tab
lib:CreateLabel(statsTab, "â• SESSION â•")
local killsLabel = lib:CreateLabel(statsTab, "Kills: 0")
local yenLabel = lib:CreateLabel(statsTab, "Yen Gained: 0")
local rcLabel = lib:CreateLabel(statsTab, "RC Gained: 0")
local uptimeLabel = lib:CreateLabel(statsTab, "Uptime: 0m")

lib:CreateButton(statsTab, "Reset Session", function()
    Stats.Kills = 0
    Stats.Yen = 0
    Stats.RC = 0
    Stats.StartTime = tick()
end)

lib:CreateLabel(statsTab, " ")
lib:CreateLabel(statsTab, "â• PLAYER â•")
local currentLevelLabel = lib:CreateLabel(statsTab, "Level: " .. player.PlayerFolder.Stats.Level.Value)
local currentYenLabel = lib:CreateLabel(statsTab, "Total Yen: " .. player.PlayerFolder.Stats.Yen.Value)

-- Debug Tab
lib:CreateLabel(debugTab, "â• STATUS â•")
local debugLabel1 = lib:CreateLabel(debugTab, "Status: Loading...")
local debugLabel2 = lib:CreateLabel(debugTab, "Key: Not found")

lib:CreateButton(debugTab, "ðŸ”‘ Find Key", function()
    debugLabel2:Set("Key: Searching...")
    
    task.spawn(function()
        pcall(function()
            fireclickdetector(workspace.TrainerModel.ClickIndicator.ClickDetector)
            waitforobj(waitforobj(player.PlayerGui, "TrainersGui"), "TrainersGuiScript")
            player.PlayerGui.TrainersGui:Destroy()
        end)
        
        task.wait(1)
        
        local attempts = 0
        repeat
            attempts = attempts + 1
            for i, v in pairs(getgc(true)) do
                if not key and type(v) == "function" then
                    pcall(function()
                        if getinfo(v).source:find("ClientControl") then
                            for i2, v2 in pairs(getconstants(v)) do
                                if v2 == "KeyEvent" then
                                    local keyfound = getconstant(v, i2 + 1)
                                    if keyfound and #keyfound >= 100 then
                                        key = keyfound
                                        debugLabel2:Set("Key: Found")
                                        print("Key: " .. #key .. " chars")
                                        return
                                    end
                                end
                            end
                        end
                    end)
                end
            end
            task.wait(0.5)
        until key or attempts > 10
        
        if not key then
            debugLabel2:Set("Key: âœ— Failed")
            warn("âœ— Key not found")
        end
    end)
end)

-- Core Functions
local function pressKey(topress)
    if not key or not player.Character:FindFirstChild("Remotes") then return end
    pcall(function()
        local fire = Instance.new("RemoteEvent").FireServer
        fire(player.Character.Remotes.KeyEvent, key, topress, "Down", player:GetMouse().Hit, nil, workspace.Camera.CFrame)
    end)
end

local function tp(targetCFrame)
    if not Config.Farming or not player.Character then return end
    
    local hrp = player.Character.HumanoidRootPart
    local distance = (hrp.Position - targetCFrame.p).Magnitude
    
    if distance < 5 then
        hrp.CFrame = targetCFrame
        return
    end
    
    local val = Instance.new("CFrameValue")
    val.Value = hrp.CFrame
    
    local tweenInfo = TweenInfo.new(distance / Config.TeleportSpeed, Enum.EasingStyle.Linear)
    local tween = get.TweenService:Create(val, tweenInfo, {Value = targetCFrame})
    tween:Play()
    
    local completed = false
    tween.Completed:Connect(function() completed = true end)
    
    while not completed and Config.Farming do
        hrp.CFrame = val.Value
        task.wait()
        if not Config.Farming then
            tween:Cancel()
            break
        end
    end
    
    val:Destroy()
end

local function getNPC()
    if #Config.BossTargets > 0 then
        local playerLevel = tonumber(player.PlayerFolder.Stats.Level.Value)
        
        for _, boss in ipairs(Config.BossTargets) do
            if playerLevel >= boss.Level then
                local bossSpawn = workspace.NPCSpawns:FindFirstChild(boss.Spawn)
                
                if bossSpawn then
                    if boss.Name == "Gyakusatsu" then
                        local lowestHP = math.huge
                        local target = nil
                        
                        for _, npc in pairs(bossSpawn:GetChildren()) do
                            if npc.Name ~= "Mob" and findobj(npc, "Humanoid") and npc.Humanoid.Health > 0 then
                                if npc.Humanoid.Health < lowestHP then
                                    lowestHP = npc.Humanoid.Health
                                    target = npc
                                end
                            end
                        end
                        
                        if target then
                            DebugText = "Boss: Gyakusatsu"
                            return target, true
                        end
                    else
                        for _, npc in pairs(bossSpawn:GetChildren()) do
                            if npc.Name == boss.Name and findobj(npc, "Humanoid") and npc.Humanoid.Health > 0 then
                                DebugText = "Boss: " .. npc.Name
                                return npc, true
                            end
                        end
                    end
                end
            end
        end
    end
    
    if #Config.NPCTargets > 0 then
        local nearest = nil
        local nearestDist = math.huge
        
        for _, spawn in pairs(workspace.NPCSpawns:GetChildren()) do
            for _, targetSpawn in ipairs(Config.NPCTargets) do
                if spawn.Name == targetSpawn then
                    local npc = findobjofclass(spawn, "Model")
                    
                    if npc and findobj(npc, "Head") and findobj(npc, "HumanoidRootPart") and not findobj(npc, "AC") then
                        if findobj(npc, "Humanoid") and npc.Humanoid.Health > 0 then
                            local dist = (npc.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                            
                            if dist < nearestDist then
                                nearest = npc
                                nearestDist = dist
                            end
                        end
                    end
                end
            end
        end
        
        if nearest then
            DebugText = "NPC: " .. nearest.Name
            return nearest, false
        end
    end
    
    DebugText = "No targets"
    return nil, false
end

local function attack(npc, isBoss)
    if not npc or not npc:FindFirstChild("HumanoidRootPart") then return end
    
    local targetHRP = npc.HumanoidRootPart
    CurrentTarget = npc.Name
    
    DebugText = "Approaching: " .. npc.Name
    local startPos = player.Character.HumanoidRootPart.Position
    local targetStartPos = targetHRP.Position
    local approachDistance = (startPos - targetStartPos).Magnitude
    
    if approachDistance > 30 then
        local approachPos
        if isBoss then
            approachPos = targetHRP.CFrame * CFrame.Angles(math.rad(90), 0, 0) + Vector3.new(0, Config.BossDistance, 0)
        else
            approachPos = targetHRP.CFrame - targetHRP.CFrame.LookVector * Config.NPCDistance
        end
        
        tp(approachPos)
    end
    
    DebugText = "Attacking: " .. npc.Name
    
    local lastEquipTime = 0
    local lastSkillTime = 0
    local isDodging = false
    
    while npc and npc.Parent and findobj(npc, "Humanoid") and npc.Humanoid.Health > 0 and Config.Farming do
        if not player.Character or player.Character.Humanoid.Health <= 0 then break end
        
        targetHRP = npc.HumanoidRootPart

        if Config.SafeMode and not isDodging then
            local healthPercent = (player.Character.Humanoid.Health / player.Character.Humanoid.MaxHealth) * 100
            if healthPercent < Config.SafeHealthPercent then
                isDodging = true
                DebugText = "Low HP! Dodging..."
                
                local safePos = player.Character.HumanoidRootPart.CFrame + Vector3.new(0, 50, 0)
                player.Character.HumanoidRootPart.CFrame = safePos
                

                if player.Character.HumanoidRootPart:FindFirstChild("BodyVelocity") then
                    player.Character.HumanoidRootPart.BodyVelocity:Destroy()
                end
                
                local bodyVel = Instance.new("BodyVelocity")
                bodyVel.Velocity = Vector3.new(0, 0, 0)
                bodyVel.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                bodyVel.Parent = player.Character.HumanoidRootPart
                
                repeat
                    task.wait(0.5)
                    healthPercent = (player.Character.Humanoid.Health / player.Character.Humanoid.MaxHealth) * 100
                    DebugText = "Healing... HP: " .. math.floor(healthPercent) .. "%"
                until healthPercent >= 80 or not Config.Farming
                
                if bodyVel and bodyVel.Parent then
                    bodyVel:Destroy()
                end
                
                isDodging = false
                DebugText = "Healed! Resuming..."
                task.wait(0.5)
            end
        end
        
        if not isDodging then
            -- Equip weapon
            if tick() - lastEquipTime > 1 then
                if not findobj(player.Character, "Kagune") and not findobj(player.Character, "Quinque") then
                    pressKey(Config.Stage)
                    lastEquipTime = tick()
                    task.wait(0.1)
                end
            end
            
            local targetPos
            if isBoss then
                targetPos = targetHRP.CFrame * CFrame.Angles(math.rad(90), 0, 0) + Vector3.new(0, Config.BossDistance, 0)
            else
                -- Stay behind the NPC
                targetPos = targetHRP.CFrame - targetHRP.CFrame.LookVector * Config.NPCDistance
            end
            
            player.Character.HumanoidRootPart.CFrame = targetPos
            
            player.Character.HumanoidRootPart.CFrame = CFrame.new(player.Character.HumanoidRootPart.Position, Vector3.new(targetHRP.Position.X, player.Character.HumanoidRootPart.Position.Y, targetHRP.Position.Z))
            
            -- Aim camera at target
            workspace.Camera.CFrame = CFrame.new(workspace.Camera.CFrame.Position, targetHRP.Position)
            
            if player.PlayerFolder.CanAct.Value and tick() - lastSkillTime > 0.3 then
                if (isBoss and Config.UseSkills) or not isBoss then
                    for skillKey, enabled in pairs(Config.Skills) do
                        if enabled then
                            local cd = SkillCDs[skillKey]
                            if cd and cd.Value ~= "DownTime" then
                                pressKey(skillKey)
                                lastSkillTime = tick()
                                task.wait(0.05)
                            end
                        end
                    end
                end
            end
            
            -- Basic attack
            if player.PlayerFolder.CanAct.Value then
                pressKey("Mouse1")
            end
        end
        
        task.wait(0.05)
    end
    
    if Config.Farming and npc and npc.Humanoid.Health <= 0 then
        Stats.Kills = Stats.Kills + 1
        DebugText = "Killed: " .. npc.Name
    end
    
    CurrentTarget = "None"
end

-- Main Farm Loop
task.spawn(function()
    while task.wait(0.5) do
        if Config.Farming then
            pcall(function()
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.Humanoid.Health > 0 then
                    local npc, isBoss = getNPC()
                    
                    if npc then
                        attack(npc, isBoss)
                    else
                        CurrentTarget = "Searching..."
                        DebugText = "No targets nearby"
                    end
                else
                    CurrentTarget = "Dead"
                    DebugText = "Respawning..."
                    task.wait(3)
                end
            end)
        end
    end
end)

-- GUI Update Loop
task.spawn(function()
    while task.wait(0.5) do
        targetLabel:Set("â— Target: " .. CurrentTarget)
        levelLabel:Set("â— Level: " .. player.PlayerFolder.Stats.Level.Value)
        quickKills:Set("Kills: " .. Stats.Kills)
        quickYen:Set("Yen: " .. Stats.Yen)
        quickRC:Set("RC: " .. Stats.RC)
        
        killsLabel:Set("Kills: " .. Stats.Kills)
        yenLabel:Set("Yen Gained: " .. Stats.Yen)
        rcLabel:Set("RC Gained: " .. Stats.RC)
        
        local uptime = math.floor((tick() - Stats.StartTime) / 60)
        uptimeLabel:Set("Uptime: " .. uptime .. "m")
        
        currentLevelLabel:Set("Level: " .. player.PlayerFolder.Stats.Level.Value)
        currentYenLabel:Set("Total Yen: " .. player.PlayerFolder.Stats.Yen.Value)
        
        debugLabel1:Set("Status: " .. DebugText)
    end
end)

-- Track currency
local lastYen = player.PlayerFolder.Stats.Yen.Value
local lastRC = player.PlayerFolder.Stats.RC.Value

player.PlayerFolder.Stats.Yen.Changed:Connect(function(val)
    if Config.Farming and val > lastYen then
        Stats.Yen = Stats.Yen + (val - lastYen)
    end
    lastYen = val
end)

player.PlayerFolder.Stats.RC.Changed:Connect(function(val)
    if Config.Farming and val > lastRC then
        Stats.RC = Stats.RC + (val - lastRC)
    end
    lastRC = val
end)

-- Track deaths
player.Character.Humanoid.Died:Connect(function()
    Stats.Deaths = Stats.Deaths + 1
end)

-- Character respawn
player.CharacterAdded:Connect(function(char)
    task.wait(1)
    char:WaitForChild("HumanoidRootPart")
    char:WaitForChild("Humanoid")
    
    char.Humanoid.Died:Connect(function()
        Stats.Deaths = Stats.Deaths + 1
    end)
end)

-- Anti-AFK
pcall(function()
    getconnections(player.Idled)[1]:Disable()
end)

-- Auto-find key
task.spawn(function()
    print("Ro-Ghoul Auto Farm")
    print("Finding key...")
    DebugText = "Finding key..."
    
    pcall(function()
        fireclickdetector(workspace.TrainerModel.ClickIndicator.ClickDetector)
        waitforobj(waitforobj(player.PlayerGui, "TrainersGui"), "TrainersGuiScript")
        player.PlayerGui.TrainersGui:Destroy()
    end)
    
    task.wait(2)
    
    local attempts = 0
    repeat
        attempts = attempts + 1
        for i, v in pairs(getgc(true)) do
            if not key and type(v) == "function" then
                pcall(function()
                    if getinfo(v).source:find("ClientControl") then
                        for i2, v2 in pairs(getconstants(v)) do
                            if v2 == "KeyEvent" then
                                local keyfound = getconstant(v, i2 + 1)
                                if keyfound and #keyfound >= 100 then
                                    key = keyfound
                                    print("Key Found!")
                                    DebugText = "Ready!"
                                    debugLabel2:Set("Key: Found")
                                    return
                                end
                            end
                        end
                    end
                end)
            end
        end
        task.wait(1)
    until key or attempts > 8
    
    if not key then
        warn("Key not found!")
        warn("Use Debug tab > Find Key")
        DebugText = "Key not found"
        statusLabel:Set("Status: Key Missing!")
        debugLabel2:Set("Key: Not found")
    else
        print("Ready!")
        print("Select targets and START")
    end
end)
